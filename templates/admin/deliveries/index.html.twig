{% extends 'base.html.twig' %}
{% block title %}Ordres de livraison{% endblock %}

{% block body %}
<style>
/* tri: label + flèche */
th .sort-head{ white-space: nowrap; display:inline-flex; align-items:center; gap:.25rem; }
th .sort-head .sort-arrow{ font-size:.9em; opacity:.6; line-height:1; }
th .sort-head .sort-arrow.active{ opacity:1; font-weight:700; }
</style>

{% macro sort_link(label, col, sort, dir) %}
  {% set baseQs = app.request.query.all | merge({'sort': col, 'page': 1}) %}
  {% set nextDir = (sort == col and dir == 'asc') ? 'desc' : 'asc' %}
  {% set toggleQs = baseQs | merge({'dir': nextDir}) %}
  {% set arrow = '↕' %}
  {% set arrowClass = 'sort-arrow' %}
  {% if sort == col %}
    {% set arrow = (dir == 'asc') ? '▲' : '▼' %}
    {% set arrowClass = arrowClass ~ ' active' %}
  {% endif %}
  <span class="sort-head">
    <a href="{{ path(app.request.attributes.get('_route'), toggleQs) }}">{{ label }}</a>
    <span class="{{ arrowClass }}" aria-hidden="true">{{ arrow }}</span>
  </span>
{% endmacro %}
{% import _self as self %}

<div class="container">
  <div class="flash-container"></div>

  <div class="d-flex align-items-center justify-content-between mb-3">
    <h1 class="h3 mb-0">Ordres de livraison</h1>
    <a class="btn btn-sm btn-outline-primary"
       href="{{ path('admin_deliveries_import', app.request.query.all) }}">
      Importer depuis Odoo
    </a>
  </div>

  {# Toolbar recherche centrale #}
  <form method="get"
        action="{{ path(app.request.attributes.get('_route')) }}"
        class="admin-toolbar-center d-flex align-items-center justify-content-between gap-2 flex-wrap mb-3">
    <div class="flex-grow-1 d-flex justify-content-center">
      <input type="search"
             id="q"
             name="q"
             value="{{ q }}"
             class="form-control form-control-w-560 form-control-tall"
             placeholder="Rechercher (réf, origine, client)">
      <input type="hidden" name="sort" value="{{ sort }}">
      <input type="hidden" name="dir"  value="{{ dir }}">
    </div>
    <div class="ms-0 ms-sm-2">
      <a class="btn btn-sm btn-outline-secondary" href="{{ path(app.request.attributes.get('_route')) }}">Réinitialiser</a>
    </div>
  </form>

  {# Filtres #}
  <form method="get" class="filters mb-3">
    <div class="row g-2">
      <div class="col-12 col-md-4 col-lg-3">
        <label class="form-label d-block">État</label>
        <select name="state" class="form-select">
          <option value="">— Tous —</option>
          {% set states = {
            'draft':'Brouillon','waiting':'En attente','confirmed':'Confirmé','assigned':'Réservé',
            'done':'Terminé','cancel':'Annulé'
          } %}
          {% for k, lbl in states %}
            <option value="{{ k }}" {{ state == k ? 'selected' : '' }}>{{ lbl }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-12 col-md-4 col-lg-3">
        <label class="form-label d-block">Du (prévu)</label>
        <input type="date" name="scheduled_from" class="form-control" value="{{ scheduled_from }}">
      </div>
      <div class="col-12 col-md-4 col-lg-3">
        <label class="form-label d-block">Au (prévu)</label>
        <input type="date" name="scheduled_to" class="form-control" value="{{ scheduled_to }}">
      </div>
      <div class="col-12 col-lg-3 d-flex align-items-end">
        <div>
          <button class="btn btn-primary me-2">Filtrer</button>
          {% if q or state or scheduled_from or scheduled_to %}
            <a class="btn btn-link" href="{{ path(app.request.attributes.get('_route')) }}">Réinitialiser</a>
          {% endif %}
        </div>
      </div>
    </div>
  </form>

  {% if table_exists is defined and not table_exists %}
    <div class="alert alert-info">
      Aucune donnée locale pour les ordres de livraison. Vous pourrez connecter l’import Odoo (stock.picking) pour alimenter la table <code>odoo_pickings</code>.
    </div>
  {% endif %}

  <div class="table-responsive">
    <table class="table table-striped align-middle">
      <thead>
        <tr>
          <th>{{ self.sort_link('Réf', 'name', sort, dir) }}</th>
          <th>{{ self.sort_link('Origine', 'origin', sort, dir) }}</th>
          <th>{{ self.sort_link('Client', 'partner_name', sort, dir) }}</th>
          <th class="d-none d-sm-table-cell">{{ self.sort_link('Prévu le', 'scheduled_date', sort, dir) }}</th>
          <th>{{ self.sort_link('État', 'state', sort, dir) }}</th>
        </tr>
      </thead>
      <tbody>
      {% for p in items %}
        <tr>
          <td>
            {% if p.odoo_id %}
              <a href="{{ path('admin_delivery_show', {id: p.odoo_id}) }}"><code>{{ p.name }}</code></a>
            {% else %}
              <code>{{ p.name }}</code>
            {% endif %}
          </td>
          <td>
            {% if p.order_id %}
              <a href="{{ path('admin_orders_show', {id: p.order_id}) }}">{{ p.origin ?: '—' }}</a>
            {% else %}
              {{ p.origin ?: '—' }}
            {% endif %}
          </td>
          <td>{{ p.partner_name ?: '—' }}</td>
          <td class="d-none d-sm-table-cell">{{ p.scheduled_date ? p.scheduled_date|date('Y-m-d H:i') : '—' }}</td>
          <td>{{ p.state ?: '—' }}</td>
        </tr>
      {% else %}
        <tr><td colspan="5" class="text-center text-muted">Aucun ordre de livraison.</td></tr>
      {% endfor %}
      </tbody>
    </table>
  </div>

  {% include 'admin/_pagination.html.twig' with {
    route: app.request.attributes.get('_route'),
    page: page, totalPages: totalPages,
    query: app.request.query.all
  } only %}
</div>
{% endblock %}
