{% extends 'base.html.twig' %}
{% block title %}Ordre de livraison {{ picking.name ?? ('#' ~ picking.id) }}{% endblock %}

{% block body %}
<div class="container py-4">
  {% set isClosed = (picking.state in ['done','cancel']) %}

  <div class="d-flex align-items-center justify-content-between mb-3">
    <a class="btn btn-link" href="{{ path('admin_deliveries_list') }}">← Retour à la liste</a>
    {% if linked_order %}
      <div class="d-flex gap-2">
        <a class="btn btn-sm btn-outline-secondary" href="{{ path('admin_orders_show', {id: linked_order.id}) }}">
          Voir la commande {{ linked_order.ref }}
        </a>
        <a class="btn btn-sm btn-primary" href="{{ path('admin_orders_process', {id: linked_order.id}) }}">
          Traiter la commande
        </a>
      </div>
    {% endif %}
  </div>

  <h1 class="h4 mb-3">Ordre de livraison {{ picking.name ?? ('#' ~ picking.id) }}</h1>

  <div class="row g-3 mb-3">
    <div class="col-md-6">
      <div class="card h-100">
        <div class="card-body">
          <div class="row">
            <div class="col-6"><strong>État</strong></div>
            <div class="col-6">{{ picking.state ?? 'n/a' }}</div>
            <div class="col-6"><strong>Origine</strong></div>
            <div class="col-6">{{ picking.origin ?? 'n/a' }}</div>
            <div class="col-6"><strong>Commande liée</strong></div>
            <div class="col-6">
              {% if linked_order %}
                <a href="{{ path('admin_orders_show', {id: linked_order.id}) }}">{{ linked_order.ref }}</a>
              {% else %}—{% endif %}
            </div>
            <div class="col-6"><strong>Client</strong></div>
            <div class="col-6">
              {% if picking.partner_id is iterable and picking.partner_id|length > 1 %}
                {{ picking.partner_id[1] }}
              {% else %}n/a{% endif %}
            </div>
            <div class="col-6"><strong>Prévu le</strong></div>
            <div class="col-6">{{ picking.scheduled_date ?? 'n/a' }}</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <form method="post" action="{{ path('admin_delivery_validate', {id: picking.id}) }}">
    <div class="card">
      <div class="table-responsive">
        <table class="table table-sm align-middle mb-0">
          <thead>
            <tr>
              <th>Produit</th>
              <th class="text-end">Ordered (SO)</th>
              <th class="text-end">Product UoM Qty</th>
              <th class="text-center">Picked ?</th>
              <th class="text-end">Quantity</th>
              <th class="text-end">Forecast</th>
              <th class="text-end">On hand</th>
            </tr>
          </thead>
          <tbody>
          {% for row in lines %}
            {% set demanded = row.product_uom_qty|default(0) %}
            {% set ordered  = row.ordered_qty is defined and row.ordered_qty is not null ? row.ordered_qty : '—' %}
            {% set pickedOk = row.picked|default(false) %}
            {% set pickedQty = row.picked_qty|default(0) %}
            {% set forecast = row.forecast|default(0) %}
            {% set onhand   = row.on_hand|default(0) %}
            <tr>
              <td>
                <div>{{ row.product_label }}</div>
                <div class="text-muted small">{{ row.product_uom }}</div>
              </td>
              <td class="text-end">{{ ordered }}</td>
              <td class="text-end">{{ demanded }}</td>
              <td class="text-center">
                <input type="checkbox" disabled {{ pickedOk ? 'checked' : '' }}>
              </td>
              <td class="text-end" style="min-width:120px;">
                <input type="number" name="qty[{{ row.product_id }}]" min="0" step="0.01"
                       value="{{ pickedQty > 0 ? pickedQty : demanded }}" class="form-control form-control-sm text-end"
                       {{ isClosed ? 'disabled' : '' }}>
              </td>
              <td class="text-end">
                <span class="{{ forecast < demanded ? 'text-danger fw-semibold' : 'text-success fw-semibold' }}">{{ forecast }}</span>
              </td>
              <td class="text-end">{{ onhand }}</td>
            </tr>
          {% else %}
            <tr><td colspan="7" class="text-center text-muted">Aucune ligne de picking.</td></tr>
          {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="card-body d-flex gap-2">
        <button type="submit" class="btn btn-primary" {{ isClosed ? 'disabled' : '' }}>Valider la livraison</button>
        <button type="submit" class="btn btn-outline-secondary"
                formaction="{{ path('admin_delivery_save', {id: picking.id}) }}" {{ isClosed ? 'disabled' : '' }}>
          Enregistrer sans valider
        </button>
        <a href="{{ path('admin_deliveries_list') }}" class="btn btn-link ms-auto">Retour à la liste</a>
      </div>
    </div>
  </form>
</div>
{% endblock %}
