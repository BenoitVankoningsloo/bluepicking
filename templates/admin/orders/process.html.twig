{% extends 'base.html.twig' %}
{% block title %}Traitement commande {{ o.external_order_id ?? o.id }}{% endblock %}

{% block body %}
<div class="container py-4">
  <a class="btn btn-link" href="{{ path('admin_orders_show', {'id': o.id}) }}">← Retour fiche</a>
  <h1 class="h4 mb-1">Traitement commande</h1>
  {% if odoo_state %}
    <div class="mb-3 text-muted small">État Odoo : <strong>{{ odoo_state }}</strong></div>
  {% endif %}

  {% set locked = meta.picking_validated_at is defined and meta.picking_validated_at is not null %}
  {% set isConfirmed = odoo_state in ['sale','done'] %}
  {% set isCanceled  = odoo_state == 'cancel' %}
  {% set disableConfirm = locked or isConfirmed or isCanceled %}
  {% set disableCancel  = locked or isCanceled %}

  <div class="mb-3 d-flex flex-wrap align-items-center gap-2">
    <form method="post" action="{{ path('admin_odoo_confirm_order', {'id': o.id}) }}" class="d-inline">
      <input type="hidden" name="_token" value="{{ csrf_token('odoo_confirm_' ~ o.id) }}">
      <button class="btn btn-success btn-sm" {{ disableConfirm ? 'disabled' : '' }}>Confirmer (Odoo)</button>
    </form>
    <form method="post" action="{{ path('admin_odoo_cancel_order', {'id': o.id}) }}" class="d-inline">
      <input type="hidden" name="_token" value="{{ csrf_token('odoo_cancel_' ~ o.id) }}">
      <button class="btn btn-outline-danger btn-sm" {{ disableCancel ? 'disabled' : '' }}>Annuler (Odoo)</button>
    </form>
    <form method="post" action="{{ path('admin_odoo_refresh_lines', {'id': o.id}) }}" class="d-inline">
      <input type="hidden" name="_token" value="{{ csrf_token('odoo_refresh_' ~ o.id) }}">
      <button class="btn btn-outline-primary btn-sm" {{ locked ? 'disabled' : '' }}>Mettre à jour depuis Odoo</button>
    </form>
    <form method="post" action="{{ path('admin_orders_bpost_generate', {'id': o.id}) }}" class="d-inline">
      <input type="hidden" name="_token" value="{{ csrf_token('bpost_generate_' ~ o.id) }}">
      <button class="btn btn-success btn-sm" {{ locked ? 'disabled' : '' }}>Générer via bpost</button>
    </form>
    <a class="btn btn-outline-secondary btn-sm" href="{{ path('admin_orders_picking_pdf', {'id': o.id}) }}">PDF Picking</a>
    <a class="btn btn-outline-secondary btn-sm" href="{{ path('admin_orders_delivery_pdf', {'id': o.id}) }}">PDF BL</a>
    <a class="btn btn-outline-secondary btn-sm" href="{{ path('admin_orders_labels_pdf', {'id': o.id}) }}">PDF Labels</a>
    <a class="btn btn-outline-primary btn-sm" href="{{ path('admin_orders_carrier_label_pdf', {'id': o.id}) }}"> Étiquette Bpost (PDF)</a>
    <button type="submit" class="btn btn-primary btn-sm ms-auto"
            form="push-form" {{ locked ? 'disabled' : '' }}>
      Valider le bon de livraison (Odoo)
    </button>
  </div>

  {% if locked %}
    <div class="alert alert-success py-2">
      Bon de livraison validé le {{ meta.picking_validated_at|date('Y-m-d H:i') }}.
      Champs de préparation verrouillés.
    </div>
  {% endif %}

  <form method="post">
    <div class="row g-3">
      <div class="col-md-3">
        <label class="form-label">Nombre de colis</label>
        <input type="number" min="1" class="form-control" name="parcels_count" value="{{ meta.parcels_count ?? 1 }}" {{ locked ? 'disabled' : '' }}>
      </div>
      <div class="col-md-3">
        <label class="form-label">Réf colis</label>
        <input type="text" class="form-control" name="package_ref" value="{{ meta.package_ref }}" {{ locked ? 'disabled' : '' }}>
      </div>
      <div class="col-md-6">
        <label class="form-label">Préparateur</label>
        <select class="form-select" name="prepared_by" {{ locked ? 'disabled' : '' }}>
          {% set current = meta.prepared_by ?? app.user.userIdentifier %}
          {% for u in users %}
            {% set label = u.label %}
            <option value="{{ label }}" {{ label == current ? 'selected' : '' }}>{{ label }}</option>
          {% endfor %}
          {% if users is empty %}
            <option value="{{ current }}" selected>{{ current }}</option>
          {% endif %}
        </select>
      </div>

      <div class="col-md-4">
        <label class="form-label">Transporteur</label>
        {% set carrier = o.shipping_carrier ?? meta.shipping_carrier_override ?? '' %}
        <select name="shipping_carrier" class="form-select" {{ locked ? 'disabled' : '' }}>
          <option value="" {{ carrier=='' ? 'selected' : '' }}>—</option>
          <option value="bpost" {{ carrier=='bpost' ? 'selected' : '' }}>Bpost</option>
          <option value="pickup" {{ carrier=='pickup' ? 'selected' : '' }}>Pickup</option>
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label">Service</label>
        <input type="text" class="form-control" name="shipping_service" value="{{ o.shipping_service ?? meta.shipping_service_override }}" {{ locked ? 'disabled' : '' }}>
      </div>
      <div class="col-md-4">
        <label class="form-label">Tracking</label>
        <input type="text" class="form-control" name="tracking_number" value="{{ o.tracking_number }}" {{ locked ? 'disabled' : '' }}>
      </div>
    </div>

    <hr class="my-4">

    <h2 class="h6">Adresse d’expédition</h2>
    <div class="row g-3">
      <div class="col-md-6">
        <label class="form-label">Nom</label>
        <input type="text" class="form-control" name="ship_name" value="{{ ship.name }}" {{ locked ? 'disabled' : '' }}>
      </div>
      <div class="col-md-6">
        <label class="form-label">Téléphone</label>
        <input type="text" class="form-control" name="ship_phone" value="{{ ship.phone }}" {{ locked ? 'disabled' : '' }}>
      </div>
      <div class="col-md-8">
        <label class="form-label">Adresse 1</label>
        <input type="text" class="form-control" name="ship_address1" value="{{ ship.address1 }}" {{ locked ? 'disabled' : '' }}>
      </div>
      <div class="col-md-4">
        <label class="form-label">Adresse 2</label>
        <input type="text" class="form-control" name="ship_address2" value="{{ ship.address2 }}" {{ locked ? 'disabled' : '' }}>
      </div>
      <div class="col-md-3">
        <label class="form-label">CP</label>
        <input type="text" class="form-control" name="ship_postcode" value="{{ ship.postcode }}" {{ locked ? 'disabled' : '' }}>
      </div>
      <div class="col-md-5">
        <label class="form-label">Ville</label>
        <input type="text" class="form-control" name="ship_city" value="{{ ship.city }}" {{ locked ? 'disabled' : '' }}>
      </div>
      <div class="col-md-4">
        <label class="form-label">Pays (ISO2)</label>
        <input type="text" class="form-control" name="ship_country" value="{{ ship.country }}" {{ locked ? 'disabled' : '' }}>
      </div>
    </div>

    <div class="mt-3">
      <button class="btn btn-outline-secondary" {{ locked ? 'disabled' : '' }}>Enregistrer</button>
      <a class="btn btn-link" href="{{ path('admin_orders_show', {'id': o.id}) }}">Annuler</a>
    </div>
  </form>

  <hr class="my-4">
  <h2 class="h6">Produits à préparer</h2>

  <form id="push-form" method="post" action="{{ path('admin_odoo_push_validate', {'id': o.id}) }}">
    <input type="hidden" name="_token" value="{{ csrf_token('odoo_pushval_' ~ o.id) }}">
    <div class="table-responsive">
      <table class="table table-sm align-middle">
        <thead>
          <tr>
            <th style="width:20%;">SKU</th>
            <th>Nom</th>
            <th class="text-end" style="width:10%;">Qté commandée</th>
            <th class="text-end" style="width:12%;">Stock Odoo</th>
            <th class="text-end" style="width:14%;">Qté préparée</th>
          </tr>
        </thead>
        <tbody>
        {% for l in lines %}
          <tr>
            <td><code>{{ l.sku }}</code></td>
            <td>{{ l.name }}</td>
            <td class="text-end">{{ l.qty }}</td>
            <td class="text-end">{{ l.odoo_qty_available is not null ? l.odoo_qty_available : '—' }}</td>
            <td class="text-end" style="min-width:120px;">
              <input type="number" step="0.01" min="0" name="prepared[{{ l.id }}]"
                     value="{{ l.prepared_qty is not null ? l.prepared_qty : '' }}"
                     class="form-control form-control-sm text-end" {{ locked ? 'disabled' : '' }}>
            </td>
          </tr>
        {% else %}
          <tr><td colspan="5" class="text-center text-muted">Aucune ligne.</td></tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
  </form>
</div>
{% endblock %}

