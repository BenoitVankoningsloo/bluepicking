{% extends 'base.html.twig' %}
{% block title %}Utilisateurs — Admin{% endblock %}

{% block body %}
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h1 class="h3 mb-0">Utilisateurs</h1>

    {% set q           = app.request.query.get('q')|default('') %}
    {% set role        = app.request.query.get('role')|default('any') %}
    {% set currentSort = app.request.query.get('sort')|default('id') %}
    {% set currentDir  = app.request.query.get('dir')|default('DESC') %}

    <a class="btn btn-sm btn-outline-primary"
       href="{{ path('admin_users_export', { q: q, role: role, sort: currentSort, dir: currentDir }) }}">
      Export CSV
    </a>
  </div>

  <form method="get"
        action="{{ path('admin_users') }}"
        class="admin-toolbar-center d-flex align-items-center justify-content-between gap-2 flex-wrap mb-3">

    <div class="flex-grow-1 d-flex justify-content-center">
      <input
        type="search"
        id="q"
        name="q"
        value="{{ q }}"
        class="form-control form-control-w-560 form-control-tall"
        placeholder="Rechercher (nom, email…)">
      <input type="hidden" name="sort" value="{{ currentSort }}">
      <input type="hidden" name="dir"  value="{{ currentDir }}">
    </div>

    <div class="d-flex align-items-center gap-2">
      <select name="role" class="form-select form-select-sm" style="min-width: 160px">
        <option value="any"  {{ role == 'any'  ? 'selected' }} >Tous les rôles</option>
        <option value="ROLE_USER"  {{ role == 'ROLE_USER'  ? 'selected' }} >ROLE_USER</option>
        <option value="ROLE_ADMIN" {{ role == 'ROLE_ADMIN' ? 'selected' }} >ROLE_ADMIN</option>
      </select>

      <a class="btn btn-sm btn-outline-secondary" href="{{ path('admin_users') }}">Réinitialiser</a>
    </div>
  </form>

  {% set sort = currentSort %}
  {% set dir  = currentDir %}

  {% set dirId       = (sort == 'id'        and dir == 'ASC') ? 'DESC' : 'ASC' %}
  {% set dirName     = (sort == 'name'      and dir == 'ASC') ? 'DESC' : 'ASC' %}
  {% set dirEmail    = (sort == 'email'     and dir == 'ASC') ? 'DESC' : 'ASC' %}
  {% set dirCreated  = (sort == 'createdAt' and dir == 'ASC') ? 'DESC' : 'ASC' %}

  <div class="table-responsive">
    <table class="table table-hover align-middle">
      <thead>
        <tr>
          <th>
            <a href="{{ path('admin_users', app.request.query.all|merge({'sort':'id','dir':dirId})) }}">
              ID{% if sort == 'id' %} {% if dir == 'ASC' %}▲{% else %}▼{% endif %}{% endif %}
            </a>
          </th>
          <th>
            <a href="{{ path('admin_users', app.request.query.all|merge({'sort':'name','dir':dirName})) }}">
              Nom{% if sort == 'name' %} {% if dir == 'ASC' %}▲{% else %}▼{% endif %}{% endif %}
            </a>
          </th>
          <th>
            <a href="{{ path('admin_users', app.request.query.all|merge({'sort':'email','dir':dirEmail})) }}">
              Email{% if sort == 'email' %} {% if dir == 'ASC' %}▲{% else %}▼{% endif %}{% endif %}
            </a>
          </th>
          <th>
            <a href="{{ path('admin_users', app.request.query.all|merge({'sort':'createdAt','dir':dirCreated})) }}">
              Créé le{% if sort == 'createdAt' %} {% if dir == 'ASC' %}▲{% else %}▼{% endif %}{% endif %}
            </a>
          </th>
          <th>Rôles</th>
          <th class="text-end">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for u in pagination %}
          <tr>
            <td>{{ u.id }}</td>
            <td>{{ u.name ?? u.email ?? u.id }}</td>
            <td>
              {% if u.email is defined and u.email %}
                <a href="mailto:{{ u.email }}">{{ u.email }}</a>
              {% else %}
                <span class="text-muted">—</span>
              {% endif %}
            </td>
            <td>
              {% if u.createdAt is defined and u.createdAt %}
                <time datetime="{{ u.createdAt|date('c') }}">{{ u.createdAt|date('Y-m-d H:i') }}</time>
              {% else %}
                <span class="text-muted">—</span>
              {% endif %}
            </td>
            <td class="text-nowrap">
              {% set roles = u.roles ?? [] %}
              {% if roles is iterable and roles|length > 0 %}
                {{ roles|join(', ') }}
              {% else %}
                <span class="text-muted">ROLE_USER (implicite)</span>
              {% endif %}
            </td>
            <td class="text-end">
              <a class="btn btn-sm btn-outline-secondary"
                 href="{{ path('admin_user_edit', app.request.query.all|merge({id: u.id})) }}">Éditer</a>
            </td>
          </tr>
        {% else %}
          <tr><td colspan="6" class="text-center text-muted">Aucun utilisateur</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="d-flex justify-content-center">
    {{ knp_pagination_render(pagination) }}
  </div>
{% endblock %}

{% block javascripts %}
  {{ parent() }}
  <script defer src="{{ asset('assets/js/admin-users.js') }}"></script>
{% endblock %}

